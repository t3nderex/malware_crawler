import os
from time import sleep



from fake_useragent import UserAgent
from webdriver_manager.chrome import ChromeDriverManager
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium import webdriver
from openpyxl import load_workbook, Workbook

from anyrun import Anyrun



ANYRUN = 'https://app.any.run/submissions'



def get_current_path():
    return os.path.dirname(os.path.abspath(__file__))


def set_driver(PROXIES=[], download_path = get_current_path()+"\samples", w_width=1400, w_height=900):
    driver_opts = webdriver.ChromeOptions()

    if PROXIES:
        pxy= PROXIES[-1]
        driver_opts.add_argument('--proxy-server=%s' % pxy)


    driver_opts.add_experimental_option('excludeSwitches', ['enable-logging'])
    
    # Download path 설정
    if not os.path.exists(download_path):
        os.makedirs(download_path)
    preferences = {
                "profile.default_content_settings.popups": 0,
                "download.default_directory": download_path,
                "directory_upgrade": True
                }
    driver_opts.add_experimental_option('prefs', preferences)
    
    # User Agent 설정
    ua = UserAgent(use_cache_server=True)    
    
    driver_opts.add_argument(f"user-agent={ua.random}")
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()),
                            options=driver_opts
                            )
    
    driver.set_window_size(w_width,w_height)

    return driver


def get_account_from_txt(file):
    with open(file, "r") as f:
        account = f.readlines()
        id = account[0]
        pw = account[1]
    return id, pw


if __name__ == '__main__':
    account = './account.txt'
    id, pw = get_account_from_txt(account)


    driver = set_driver()
    anyrun = Anyrun(driver)
    driver.implicitly_wait(10)
    driver.get(ANYRUN)
    anyrun.accepct_cookie()
    anyrun.login(id, pw)
    anyrun.set_filter_and_search(file_type='Microsoft Office',country_type='Korea, Republic of')

    last_page = anyrun.get_num_of_last_page()
    
    download_cnt = 0
    wb = Workbook()
    sheet = wb.active
    sheet.title = 'Anyrun 샘플 리스트'
    col_names = ['Name', 'Link', 'Verdict']
    for seq, name in enumerate(col_names):
        sheet.cell(row=1, column=seq+1, value=name)
    
    for currnet_page in range(last_page):
        for sample_cnt in range(1, anyrun.get_num_of_sample_page()+1):
            anyrun.enter_sample_page(sample_cnt)
            current_sample_name = anyrun.get_sample_name()
            current_sample_url = driver.current_url
            current_sample_verdirct = anyrun.get_verdict()
            sheet.cell(row = 2, column = 1, value = current_sample_name)
            sheet.cell(row = 2, column = 2, value = current_sample_url)
            sheet.cell(row = 2, column = 3, value = current_sample_verdirct)
            anyrun.download_sample()
            anyrun.driver.switch_to.window(driver.window_handles[0])
            print(f"+ ({sample_cnt})Download Complete : {current_sample_name}")
            wb.save("./samples/Anyrun_sample.xlsx")

            wb.close()
            sleep(5)
        anyrun.turn_page()
    wb.save("./samples/Anyrun_sample.xlsx")
    wb.close()
    driver.quit()
    print("다운로드 완료")
    print("**********************************************************")