import os
from time import sleep



from fake_useragent import UserAgent
from webdriver_manager.chrome import ChromeDriverManager
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium import webdriver
from openpyxl import load_workbook, Workbook

from anyrun import Anyrun



ANYRUN = 'https://app.any.run/submissions'



def get_current_path():
    return os.path.dirname(os.path.abspath(__file__))


def set_driver(PROXIES=[], download_path = get_current_path()+"\samples", w_width=1400, w_height=900):
    driver_opts = webdriver.ChromeOptions()

    if PROXIES:
        pxy= PROXIES[-1]
        driver_opts.add_argument('--proxy-server=%s' % pxy)

    # 개발자 도구 로그 제거
    driver_opts.add_experimental_option('excludeSwitches', ['enable-logging'])
    
    # Download path 설정
    if not os.path.exists(download_path):
        os.makedirs(download_path)
    preferences = {
                "profile.default_content_settings.popups": 0,
                "download.default_directory": download_path,
                "directory_upgrade": True 
                }
    driver_opts.add_experimental_option('prefs', preferences)
    
    # User Agent 설정
    ua = UserAgent(use_cache_server=True)    
    
    driver_opts.add_argument(f"user-agent={ua.random}")
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()),
                            options=driver_opts
                            )
    
    driver.set_window_size(w_width,w_height)

    return driver


def get_account_from_txt(file):
    with open(file, "r") as f:
        account = f.readlines()
        id = account[0]
        pw = account[1]
    return id, pw


if __name__ == '__main__':
    
    # set excel

    account = './account.txt'
    id, pw = get_account_from_txt(account)
    
    # 필수
    driver = set_driver()
    anyrun = Anyrun(driver, id, pw)
    anyrun.set_filter_and_search(file_type='Microsoft Office',country_type='Korea, Republic of')
    anyrun.get_samples(start_page=1)
